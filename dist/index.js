(()=>{var __webpack_exports__={};const formattedMoney=t=>new Intl.NumberFormat("en-US",{style:"decimal",minimumFractionDigits:2,maximumFractionDigits:2}).format(t),replaceCommaWithDot=t=>String(t).replace(/,/g,"");class Dep{constructor(){this.allUpdateFns={}}depend(t,e){this.allUpdateFns[t]=e}notify(t){(this.allUpdateFns[t]||[]).forEach((t=>t()))}filter(t,e){const a=this.allUpdateFns[t]||[];this.allUpdateFns[t]=a.filter((t=>t===e))}}class Event{constructor(){this.objFn={}}$emit(t,...e){(this.objFn[t]||[]).forEach((t=>t(e)))}$on(t,e){const a=this.objFn[t]||[];a.push(e),this.objFn[t]=a}}const globalEvent=new Event;class Radio{constructor({selector:t,field:e,value:a,inputData:i}){this.selector=t,this.field=e,this.value=a,this.inputData=i;const s=document.querySelector(t).cloneNode(!0);s.removeAttribute("id"),s.classList.remove("hidden"),this.el=s;let n=a;Object.defineProperty(this,"value",{get:()=>n,set(t){n=t;const a=s.querySelector(`input[type="radio"][value="${t}"]`);a&&(a.checked=!0),i[e].value!==t&&(i[e].value=t)}}),this.createEvent()}createEvent(){this.el.onchange=t=>{this.value=t.target.value}}}class Select{constructor({selector:t,field:e,value:a,inputData:i}){this.selector=t,this.field=e,this.value=a,this.inputData=i;const s=document.querySelector(t).cloneNode(!0);s.removeAttribute("id"),s.classList.remove("hidden"),this.el=s;let n=a;Object.defineProperty(this,"value",{get:()=>n,set(t){s.value=n=t,i[e].value!==t&&(i[e].value=t)}}),this.createEvent()}createEvent(){this.el.onchange=t=>{this.value=t.target.value}}}class InputSearch{constructor({selector:t,field:e,rowName:a,key:i,value:s,options:n=[],inputData:l,pagination:o={page:1,pageSize:10,total:0},randerFiled:r={text:"text",value:"value"},getServerData:c,liClickCallback:h,customizableInput:u}){this.field=e,this.key=i,this.rowName=a,this.value=s,this.options=n,this.inputData=l,this.pagination=o,this.getData=c,this.liClickCallback=h,this.randerFiled=r,this.customizableInput=u,this.el=null,this.inputEl=null,this.optionsEl=null,this.ulEl=null,this.emptyEl=null,this.loadingEl=null,this.isClickLi=!1,t&&this.setOptions(t);const d=this;let p=s;Object.defineProperty(this,"value",{get:()=>p,set(t){p=t,d.inputEl.value=t,l[e].value!==t&&(l[e].value=t)}}),this.createEl()}setOptions(t){const e=document.querySelector(t).querySelectorAll("option")||[];this.options=[...e].map((t=>({[this.randerFiled.text]:t.value}))).filter((t=>t[this.randerFiled.text]))}createEl(){const t=new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&(s||e(this.value))}))})),e=async t=>{if("function"==typeof this.getData)try{const e=await this.getData({value:t,...this.pagination}),a=this.createLiEl(e.data);this.ulEl.appendChild(a),Object.assign(this.pagination,{page:this.pagination.page+1,total:e.total});const{page:i,pageSize:s,total:n}=this.pagination;this.emptyEl.style.display=n?"none":"block",i*s>=n&&(this.loadingEl.style.display="none")}catch{}else{this.loadingEl.style.display="none",this.ulEl.innerHTML="";const e=this.options.filter((e=>e[this.randerFiled.text].includes(t)));this.emptyEl.style.display=e.length?"none":"block";const a=this.createLiEl(e);this.ulEl.appendChild(a)}},{value:a}=this,i=document.createElement("div");i.classList.add("searchInput"),i.innerHTML='<svg data-v-cc0be98c="" fill="none" viewBox="0 0 24 24" width="1em" height="1em" class="t-icon t-icon-chevron-up">\n\t\t<path data-v-cc0be98c="" fill="currentColor" d="M17.5 15.91l-5.5-5.5-5.5 5.5-1.41-1.41L12 7.59l6.91 6.91-1.41 1.41z">\n\t\t</path>\n\t</svg>',this.el=i;let s=null;const n=document.createElement("input");n.setAttribute("type","text"),n.setAttribute("value",a),n.setAttribute("placeholder","请选择"),n.classList.add("td_edit"),n.oninput=async t=>{this.isClickLi=!1,this.ulEl.innerHTML="",this.loadingEl.style.display="block",this.emptyEl.style.display="none",Object.assign(this.pagination,{page:1,total:0}),s&&clearTimeout(s),await new Promise((t=>s=setTimeout(t,500))),s=null;const a=t.target.value;e(a)},n.onfocus=async()=>{window.innerHeight-n.getBoundingClientRect().bottom-44<=200&&(this.optionsEl.childNodes[0].style.bottom="40px",this.optionsEl.childNodes[0].style.top="initial"),this.ulEl.innerHTML="",this.loadingEl.style.display="block",this.emptyEl.style.display="none",Object.assign(this.pagination,{page:1,total:0}),this.optionsEl.style.opacity=1,this.optionsEl.style.display="block",this.inputEl.select(),s&&clearTimeout(s),await new Promise((t=>s=setTimeout(t,500))),s=null,e(this.value)},n.onblur=t=>{setTimeout((()=>{this.optionsEl.style.opacity=0,this.optionsEl.style.display="none",this.isClickLi||this.customizableInput?this.value=t.target.value:t.target.value=this.value}),200)},this.inputEl=n;const l=document.createElement("div");l.classList.add("options"),this.optionsEl=l,i.appendChild(n),i.appendChild(l);const o=document.createElement("div");l.appendChild(o);const r=document.createElement("ul");this.ulEl=r;const c=document.createElement("div");c.classList.add("empty"),c.innerHTML="暂无数据",this.emptyEl=c;const h=document.createElement("div");h.classList.add("loading"),h.innerHTML='<svg focusable="false" data-icon="loading" width="1em" height="1em" fill="currentColor" aria-hidden="true" viewBox="0 0 1024 1024"><path d="M988 548c-19.9 0-36-16.1-36-36 0-59.4-11.6-117-34.6-171.3a440.45 440.45 0 00-94.3-139.9 437.71 437.71 0 00-139.9-94.3C629 83.6 571.4 72 512 72c-19.9 0-36-16.1-36-36s16.1-36 36-36c69.1 0 136.2 13.5 199.3 40.3C772.3 66 827 103 874 150c47 47 83.9 101.8 109.7 162.7 26.7 63.1 40.2 130.2 40.2 199.3.1 19.9-16 36-35.9 36z"></path></svg>',t.observe(h),this.loadingEl=h,o.appendChild(r),o.appendChild(c),o.appendChild(h),e(this.value)}createLiEl(t=[]){const e=document.createDocumentFragment(),a=this.randerFiled.text;for(let i=0;i<t.length;i++){const s=t[i],n=document.createElement("li");n.classList.add("ellipsis"),n.innerText=s[a],n.title=s[a],n.onclick=()=>{const t=this.ulEl.querySelector(".active");t&&t.classList.remove("active"),n.classList.add("active"),this.value=s[a],this.inputEl.value=s[a],this.isClickLi=!0,this.liClickCallback&&this.liClickCallback({item:s,rowName:this.rowName,inputData:this.inputData})},e.appendChild(n)}return e}}class Input{constructor({field:t,key:e,value:a,xFormula:i="",yFormula:s="",sFormula:n="",xFormulaMode:l="",yFormulaMode:o="",xExclude:r=[],yExclude:c=[],needVerification:h=!1,maxLength:u="17",inputData:d,rowName:p,rowData:m,colData:f,variable:v={},isReadOnly:g=!1,dep:y,eventBus:E,tableLinkage:D,tableLinkageFieldList:b=[],formatValue:w,formatOriginValue:F,changeOValue:C=!1}){if("[object Object]"===Object.prototype.toString.call(D)){const{eventName:t,callback:e}=D;globalEvent.$on(t,e)}this.formatValue=w,this.dep=y,this.eventBus=E;const L=document.createElement("input");L.setAttribute("type","text"),L.setAttribute("value",a),L.classList.add("td_edit"),g&&(L.setAttribute("readOnly",!0),L.setAttribute("data-field",t),L.classList.add("td_edit_readOnly")),this.el=L,this.key=e,this.value=a,this.xFormula=i,this.yFormula=s,this.sFormula=n,this.xFormulaMode=l,this.yFormulaMode=o,this.xExclude=r,this.yExclude=c,this.needVerification=h,this.maxLength=u,this.inputData=d,this.rowName=p,this.field=t,this.variable=v,this.rowData=m,this.colData=f,this.waitDelFormulafn={},this.parseFormula();let x=a;Object.defineProperty(this,"value",{get:()=>x,set(e){if(b.length){const a=b.map((a=>a===t?e:d[a].value));globalEvent.$emit(D,...a)}if(g){L.setAttribute("title",e);const t=new CustomEvent("customChange",{detail:{message:e}});L.dispatchEvent(t)}L.value=x=e,C&&F&&"function"==typeof F&&(d[t].oValue=F(e)),d[t].value!==e&&(d[t].value=e)}}),g||this.createEvent(),this.eventListeners()}eventListeners(){this.eventBus.$on("changFormula",(()=>{this.changFormula(),this.parseFormula()}))}changFormula(){const{waitDelFormulafn:t}=this;Object.keys(t).forEach((e=>{delete t[e],this.dep.filter(e,t[e])}))}parseFormula(){if("allY"===this.yFormulaMode){const{rowData:t,rowName:e,yExclude:a}=this;this.yFormula=t.map((t=>t.rowName===e||a.includes(t.rowName)?"0":`[${t.rowName}]`)).join(" + ")}if("allX"===this.xFormulaMode){const{field:t,colData:e,rowName:a}=this;this.xFormula=e.map((e=>e.key+a===t?"0":`[${e.key+a}] + `)).join("")}this.parseSFormula(),this.parseXFormula(),this.parseYFormula()}parseSFormula(){let{sFormula:t}=this;if(!t)return;const e=t.split(/( \+ | - | * | \/)/).map((t=>t.replace(",",""))),a=e.filter((t=>/^\[.*\]$/.test(t)));this.depend({computeArr:e,fields:a})}parseXFormula(){let{xFormula:t,rowName:e}=this;if(!t)return;const a=t.split(/( \+ | - | * | \/)/),i=a.filter((t=>/^\[.*\]$/.test(t)));this.depend({computeArr:a,fields:i,splicingStr:e})}parseYFormula(){let{yFormula:t,key:e}=this;if(!t)return;let a=t.split(/( \+ | - | * | \/)/);a=a.map((t=>{if(!/^\[.*\]$/.test(t))return t;return`[${e+t.slice(t.includes("$")?2:1,-1).trim()}]`}));const i=a.filter((t=>/^\[.*\]$/.test(t)));this.depend({computeArr:a,fields:i})}depend({computeArr:t,fields:e,splicingStr:a=""}){(e=e.filter((t=>!t.includes("$")))).forEach((e=>{const i=e.slice(1,-1).trim()+a,s=this.dep.allUpdateFns[i]||[],n=()=>{const e=t.map((t=>{if(/^\{.*\}$/.test(t)){const e=t.slice(1,-1).trim();return this.variable[e]}if(/^\[.*\]$/.test(t)){const e=t.slice(1,-1).trim()+a;let i=String(this.inputData[e]?.value);return i.endsWith("%")&&(i=i.slice(0,-1)/100),t.includes("$")&&(i=String(this.inputData[t.slice(2,-1).trim()+a].oValue)),+replaceCommaWithDot(i)}return t})).join("").replace("，",","),i=new Function("return "+e)(),{formatValue:s}=this;this.value=s&&"function"==typeof s?s(i):formattedMoney(i)};s.push(n),this.dep.depend(i,s),"allY"!==this.yFormulaMode&&"allX"!==this.xFormulaMode||(this.waitDelFormulafn[i]=n)}))}createEvent(){this.el.onfocus=t=>{if(this.needVerification)return;const e=replaceCommaWithDot(this.value);this.formatValue&&"function"==typeof this.formatValue?this.value=this.formatValue(e):this.value=Boolean(+e)?+e:"",t.target.select()},this.el.onblur=()=>{if(!this.needVerification)if(this.formatValue&&"function"==typeof this.formatValue){const t=this.el.value;this.value=this.formatValue(t)}else this.blurInput()}}blurInput(){const t=this.el.value;var e="0.00",a=replaceCommaWithDot(t);if(!isNaN(a)&&!isNaN(parseFloat(a))){var i=parseFloat(a);if(!isNaN(i)){var s=i.toFixed(2);(-1===s.indexOf(".")||s.substring(s.indexOf(".")+1).length<2)&&(s+="0"),s.length>17&&(s=s.substring(0,17)),e=formattedMoney(s)}}this.value=e}}class Rander{constructor({rowData:t,colData:e,separateConfig:a,unique:i,activeComputing:s,dep:n,eventBus:l}){this.dep=n,this.eventBus=l,this.tableLinkageList={},this.rowData=t,this.colData=e,this.separateConfig=a,this.inputs=[],this.InputSearchs=[],this.selects=[],this.radios=[],this.unique=String(i),this.activeComputing=s,this.waitFixedTd=[],this.addBtnEl=null,this.selector="";const{randerList:o,inputData:r}=this.handleData({rowData:this.rowData,colData:this.colData});this.randerList=o||[],this.inputData=r||{},this.waitRanderTemplate=this.generateRanderTemplate(this.randerList),this.responsiveness(this.inputData)}handleData(t){const e=[],a={},{rowData:i,colData:s}=t;return i.forEach(((t,i)=>{const n=[];let{rowName:l,tRowName:o,variable:r={},formulas:{formula:c="",independ:h={},exclude:u=[],mode:d=""}={}}=t||{};const p=Object.assign({},t);delete p.variable,delete p.formulas,s.forEach((t=>{let e=c,{key:s,textList:m=[],variable:f={},formulas:{formula:v="",independ:g={},exclude:y=[],mode:E=""}={}}=t||{};const D=`[${s},${l}]`,b=Object.assign({},t);delete b.variable,delete b.formulas;const{formulas:{formula:w,xMode:F,yMode:C}={}}=this.separateConfig[D]||{},L=Object.assign({},this.separateConfig[D]);delete L.formulas;const x=Object.assign(f,r);E=F||E,d=C||d,e=h[s]||e,u.includes(s)&&(e=""),v=g[l]||v,y.includes(l)&&(v="");const k={...t,...p,...b,...m.length?{text:m[i]}:{},...L,rowName:l,tRowName:o,variable:x,xFormula:v,yFormula:e,sFormula:w,yFormulaMode:d,xFormulaMode:E,xExclude:y,yExclude:u};if(k.oValue=k.oValue||k.value,"string"==typeof k.tableLinkage){const t=this.tableLinkageList[k.tableLinkage]||[];this.tableLinkageList[k.tableLinkage]=t.concat(s+l)}n.push(k),a[s+l]=k})),e.push(n)})),{randerList:e,inputData:a}}updateFieldValue(t,e){this.inputData[t].value=e}responsiveness(t){const{activeComputing:e,dep:a}=this,i=[...this.inputs,...this.InputSearchs,...this.selects,...this.radios];Object.keys(t).forEach((s=>{let n=t[s].value;Object.defineProperty(t[s],"value",{get:()=>n,set(t){const l=i.find((t=>t.field===s));if(l){if(l.value=n=t,!e)return a.notify(s);Promise.resolve().then((()=>a.notify(s)))}}})}))}generateRanderTemplate(t){const e=document.createDocumentFragment();return t.forEach((t=>{const a=document.createElement("tr");t.forEach((t=>{const{colspan:e=1,rowspan:i=1,isShow:s=!0,fixed:n}=t;if(!s)return;const l=document.createElement("td");l.setAttribute("colspan",e),l.setAttribute("rowspan",i);const o=this.generateChildNode(t,a);l.appendChild(o),a.appendChild(l),n&&this.waitFixedTd.push(l)})),e.appendChild(a)})),e}generateChildNode(t,e){const{key:a,rowName:i,childNodeType:s="input",selector:n,text:l="--",value:o,addRowName:r,insertMode:c,tableLinkage:h}=t;if(o&&(t.value=o),["input","readOnly"].includes(s)){const{inputData:e,colData:n,rowData:l}=this,o="readOnly"===s,r=a+i,c=new Input({...t,tableLinkageFieldList:this.tableLinkageList[h],field:r,isReadOnly:o,inputData:e,rowData:l,colData:n,dep:this.dep,eventBus:this.eventBus});return this.inputs.push(c),c.el}if("inputSearch"===s){const{inputData:e}=this,s=a+i,n=new InputSearch({...t,field:s,inputData:e});return this.InputSearchs.push(n),n.el}if("text"===s)return document.createTextNode(l);if("select"===s){if(!n||!n.startsWith("#"))throw new Error("childNodeType为select类型时未指定selector选项且selector必须为id选择器");const{inputData:e}=this,s=a+i,l=new Select({...t,inputData:e,field:s,selector:n});return this.selects.push(l),l.el}if("radio"===s){if(!n||!n.startsWith("#"))throw new Error("childNodeType为radio类型时未指定selector选项且selector必须为id选择器");const{inputData:e}=this,s=a+i,l=new Radio({...t,inputData:e,field:s,selector:n});return this.radios.push(l),l.el}if("addBtn"===s){const t=document.createElement("div");return t.classList.add("td_add"),t.onclick=()=>{this.addRow({rowName:r,insertMode:c,scroll:!0})},this.addBtnEl=t,t}if("delBtn"===s){const t=document.createElement("div");return t.classList.add("td_del"),t.onclick=()=>{this.removeRow(i,e)},t}if("delDisableBtn"===s){const t=document.createElement("div");return t.classList.add("td_del_disable"),t}}$mount(t=this.selector){if("string"!=typeof t)throw new Error("渲染失败：请检查 $mount 传参");this.selector=t;const e=document.querySelector(t),{waitRanderTemplate:a}=this;return e.appendChild(a),this.randerFixedStyle(),this}randerFixedStyle(){const{waitFixedTd:t}=this;t.forEach((t=>{const e=t.parentNode.offsetLeft,a=t.offsetLeft;Object.assign(t.style,{position:"sticky",left:a-e+"px",backgroundColor:"#fafafa"})}))}addRow({rowName:t,insertMode:e,scroll:a}){const i=document.querySelector(".content-table"),{colData:s,rowData:n}=this,l=n.find((e=>e.rowName===t)),o=JSON.parse(JSON.stringify(l)),r=Math.max(...n.map((t=>parseInt(t.rowName))))+1;Object.assign(o,{rowName:String(r)}),n.push(o);const{randerList:c,inputData:h}=this.handleData({rowData:[o],colData:s,separateConfig:this.separateConfig});Object.assign(this.inputData,h);const u=this.generateRanderTemplate(c);if(this.waitRanderTemplate=u,this.responsiveness(h),"insertBefore"===e){const t=this.addBtnEl.closest("tr");document.querySelector(this.selector).insertBefore(u,t)}else this.$mount();a&&i.scrollTo({left:0,top:i.scrollTop+60,behavior:"smooth"}),this.eventBus.$emit("changInputData"),this.eventBus.$emit("changInputs");Boolean(n.find((t=>"allY"===t?.formulas?.mode)))&&this.eventBus.$emit("changFormula")}removeRow(t,e){const{colData:a,rowData:i,inputData:s}=this,n=i.findIndex((e=>e.rowName===t)),l=a.map((t=>t.key+i[n].rowName));this.inputs=this.inputs.filter((t=>!l.includes(t.field))),this.InputSearchs=this.InputSearchs.filter((t=>!l.includes(t.field))),this.selects=this.selects.filter((t=>!l.includes(t.field))),this.radios=this.radios.filter((t=>!l.includes(t.field))),l.forEach((t=>{s[t].value="0.00",delete s[t]})),i.splice(n,1),e.remove(),this.eventBus.$emit("changInputData"),this.eventBus.$emit("changInputs");Boolean(i.find((t=>"allY"===t?.formulas?.mode)))&&this.eventBus.$emit("changFormula")}addCol(){}removeCol(){}echoData(t,e=((t,e)=>{const a=e.HC?"HC":"EWBHXH";if(!a)throw new Error("数据回显失败：请检查handleEchoData回调函数");return(t.tRowName||t.rowName)===e[a]})){const a=Object.values(this.inputData).find((t=>"addBtn"===t.childNodeType&&t.addRowName));if(a){const e=t.length-this.rowData.length;for(let t=0;t<e;t++)this.addRow({rowName:a.addRowName,insertMode:a.insertMode})}t.forEach((t=>{Object.values(this.inputData).filter((a=>e(a,t))).forEach((e=>{const{sendField:a,formatValue:i,formatOriginValue:s}=e;if(!a)return;let n=t[a],l=n;n=i&&"function"==typeof i?i(n):formattedMoney(+n||0),l=s&&"function"==typeof s?s(l):formattedMoney(+l||0),Object.assign(e,{value:n,oValue:l})}))}))}sendData(t="HC"){const e=[],{rowData:a,inputData:i}=this;return a.forEach((a=>{const{rowName:s,tRowName:n,isSend:l=!0,additionalFields:o={}}=a,r={[t]:n||s,...o};l&&(Object.values(i).forEach((e=>{let{rowName:a,tRowName:i,sendField:s,sendValue:n="value"}=e;s&&(i||a)===r[t]&&(r[s]=o[s]||replaceCommaWithDot(e[n]))})),e.push(r))})),e}}class UI{constructor(t={},e=!1){this.index=0,this.allData={},this.exampleList=[],this.globalConfig=t,this.activeComputing=e,this.dep=new Dep,this.eventBus=new Event,this.initEventListeners(),this.dependGlobalConfig()}render(t,e,a={},i,s=this.index++){return this.handleData(t,e,a,i,s)}handleData(t,e,a,i,s){const n=new Rander({rowData:t,colData:e,separateConfig:a,unique:s,activeComputing:void 0===i?this.activeComputing:i,dep:this.dep,eventBus:this.eventBus});return this.exampleList.push(n),this.setTapCursor(),this.setAllData(),n}setTapCursor(){const t=this.exampleList.map((t=>t.inputs)).flat();t.forEach(((e,a)=>{e.el.onkeydown=e=>{if("Enter"===e.key){e.preventDefault();var i=a+1;i>=t.length||t[i].el.focus()}}}))}setAllData(){this.exampleList.forEach((t=>{const{inputData:e}=t;Object.assign(this.allData,e)}))}initEventListeners(){this.eventBus.$on("changInputData",(()=>this.setAllData())),this.eventBus.$on("changInputs",(()=>this.setTapCursor()))}dependGlobalConfig(){const{separateConfig:t={}}=this.globalConfig;Object.keys(t).forEach((e=>{const{formula:a}=t[e]||{};if(!a)return;const i=a.split(/( \+ | - | * | \/)/).map((t=>t.replace(",",""))),s=i.filter((t=>/^\[.*\]$/.test(t)));this.depend({computeArr:i,fields:s,k:e.replace(/[\[\],]/g,"")})}))}depend({computeArr:t,fields:e,k:a}){e.forEach((e=>{const i=e.slice(1,-1).trim(),s=this.dep.allUpdateFns[i]||[];s.push((()=>{const e=t.map((t=>{if(/^\[.*\]$/.test(t)){const e=t.slice(1,-1).trim(),a=this.allData[e].value;return+replaceCommaWithDot(a)}return t})).join("").replace("，",","),i=new Function("return "+e)(),{formatValue:s}=this.allData[a];this.allData[a].value=s&&"function"==typeof s?s(i):formattedMoney(i)})),this.dep.depend(i,s)}))}groupEchoData(t,e,a){const i={};t.forEach((t=>{const a=t[e]||"0";i[a]=(i[a]||[]).concat(t)})),Object.keys(i).forEach((t=>{const e=i[t];this.exampleList.find((e=>e.unique===t)).echoData(e,a)}))}handleEchoData(t,e){this.groupEchoData(t,Symbol(),e)}handleMergeEchoData(t,e=(()=>!0)){this.exampleList.forEach((a=>{a.echoData(t,e)}))}handleSendData(t="HC"){const{exampleList:e}=this;return e.map((e=>e.sendData(t))).flat()}handleMergeSendData(){const t=this.handleSendData(),e={};return t.forEach((t=>{Object.assign(e,t)})),[e]}}["formattedMoney","replaceCommaWithDot","Dep","Event","globalEvent","Radio","Select","InputSearch","Input","Rander","UI"].forEach((k=>{window[k]=window[k]||eval(k)}))})();